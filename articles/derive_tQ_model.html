<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Derive the functional form, parameterization, and implementation for the robust tQ enzyme kinetics model.">
<title>Derive: tQ Model -- Enzyme Kinetics â€¢ BayesPharma</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Derive: tQ Model -- Enzyme Kinetics">
<meta property="og:description" content="Derive the functional form, parameterization, and implementation for the robust tQ enzyme kinetics model.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">BayesPharma</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/apply_MuSyC_KCNQ.html">Apply: MuSyC Model -- KCNQ Conductance</a>
    <a class="dropdown-item" href="../articles/apply_sigmoid_KOR.html">Apply: Sigmoid Model -- KOR Antagonists</a>
    <a class="dropdown-item" href="../articles/apply_sigmoid_model_Pnear.html">Apply: Sigmoid Model -- Pnear Folding Funnel</a>
    <a class="dropdown-item" href="../articles/apply_tQ_model_ChABC_design.html">Apply: tQ Model -- ChABC Design</a>
    <a class="dropdown-item" href="../articles/apply_tQ_model_nSMase2_kinetics.html">Apply: tQ Model -- nSMase2 Kinetics</a>
    <a class="dropdown-item" href="../articles/derive_MuSyC_model.html">Derive: MuSyC Model -- Synergy Analysis</a>
    <a class="dropdown-item" href="../articles/derive_tQ_model.html">Derive: tQ Model -- Enzyme Kinetics</a>
    <a class="dropdown-item" href="../articles/implement_tidymodels.html">Implement: BayesPharma and Tidymodels</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Derive: tQ Model -- Enzyme Kinetics</h1>
            
      
      
      <div class="d-none name"><code>derive_tQ_model.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="enzyme-kinetic-modeling">Enzyme Kinetic Modeling<a class="anchor" aria-label="anchor" href="#enzyme-kinetic-modeling"></a>
</h2>
<p>Enzymes are proteins that catalyze chemical reactions. Not only do
they facilitate producing virtual all biological matter, but they are
crucial for regulating biological processes. In the early 20th century
Michaelis and Menten described a foundational kinematic model for
enzymes, where the substrate and enzyme reversibly bind, the substrate
is converted to the product and then released.</p>
<pre><code>              kf
             ---&gt;     kcat
      E + S  &lt;---  C ---&gt;  E + P
              kb</code></pre>
<p>where the free enzyme (E) reversibly binds to the stubstrate (S) to
form a complex (C) with forward and backward rate constants of kf and
kb, which is irreversibly catalyzed into the product (P), with rate
constant of kcat, releasing the enzyme to catalyze additional substrate.
The total enzyme concentration is defined to be the
<code>ET := E + C</code>. The total substrate and product concentration
is defined to be <code>ST := S + C + P</code>. The Michaelis constant is
the defined to be the <code>kM := (kb + kcat) / kf</code>. The
<code>kcat</code> rate constant determines the maximum turn over at
saturating substrate concentrations, <code>Vmax := kcat * ET</code>. The
rate constants <code>kcat</code> and <code>kM</code> can be estimated by
monitoring the product accumulation over time (enzyme progress curves),
by varying the enzyme and substrate concentrations.</p>
<p>By assuming that the enzyme concentration is very low (ET &lt;&lt;
ST), they derived their celebrated Michaelis-Menten kinetics. Since
their work, a number of groups have developed models for enzyme kinetics
that make less stringent assumptions. Recently (Choi, et al., 2017),
described a Bayesian model for the total QSSA model. To make their model
more accessible, we have re-implemented it in the Stan/BRMS framework
and made it available through the <code>BayesPharma</code> package.</p>
</div>
<div class="section level2">
<h2 id="outline-for-vignette">Outline for Vignette<a class="anchor" aria-label="anchor" href="#outline-for-vignette"></a>
</h2>
<p>Next we will formally define the problem and formulate the model as
the solution to an ordinary differential equation. To illustrate, we
will consider a a toy system where we assuming the <code>kcat</code> and
<code>kM</code> are known and simulate a sequence of measurements using
deSolve. We will then implement the ODE in Stan/BRMS using stanvars and
show how the parameters of the toy system can be estimated. Since it is
common to vary the enzyme and substrate concentrations in order to
better estimate the kinematic parameters, we will show how we can
improve the Stan/BRMS model to allow multiple observations, each with an
arbitrary number of measurements. Then finally, we will consider a real
enzyme kinetics data set and use the Stan/BRMS model to estimate the
kinematic parameters. We will compare estimated parameters with those
fit using standard approaches.</p>
</div>
<div class="section level2">
<h2 id="problem-statement">Problem Statement<a class="anchor" aria-label="anchor" href="#problem-statement"></a>
</h2>
<p>Implement the total QSSA model in stan/BRMS, a refinement of the
classical Michaelis-Menten enzyme kinetics ordinary differential
equation described in (Choi, et al., 2017, DOI:
10.1038/s41598-017-17072-z). From their equation 2:</p>
<pre><code>Observed data:
  M     = number of measurements # The product concentration Pt is measured
  t[M]  = time                   # at M time points t
  Pt[M] = product                # 
  ST    = substrate total conc.  # Substrate and enzyme concentrations are
  ET    = enzyme total conc.     # assumed to be given for each observation

Model parameters:
  kcat    # catalytic constant
  kM      # Michaelis constant

ODE formulation:
  dPdt = kcat * (                # Change in product concentration at time t
    ET + kM + ST - Pt +          
    -sqrt((ET + kM + ST - Pt)^2 - 2* ET * (ST - Pt))) / 2
  initial condition:
    P := 0                       # There is zero product at time 0</code></pre>
<p>In (Choi, et al.Â 2017) they prove, that the tQ model is valid
when</p>
<pre><code> K/(2*ST) * (ET+kM+ST) / sqrt((ET+kM+ST+P)^2 - 4*ET(ST-P)) &lt;&lt; 1,</code></pre>
<p>where <code>K = kb/kf</code> is the dissociation constant.</p>
</div>
<div class="section level2">
<h2 id="simulate-one-observation">Simulate one observation<a class="anchor" aria-label="anchor" href="#simulate-one-observation"></a>
</h2>
<p>Using the <code>deSolve</code> package we can simulate data following
the total QSSA model. Measurements are made with random Gaussian noise
with mean <code>0</code> and variance of <code>0.5</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tQ_model_generate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">kcat</span>, <span class="va">kM</span>, <span class="va">ET</span>, <span class="va">ST</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ode_tQ</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">Pt</span>, <span class="va">theta</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">theta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span></span>
<span>      <span class="va">ET</span> <span class="op">+</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">ST</span> <span class="op">-</span> <span class="va">Pt</span> <span class="op">+</span></span>
<span>      <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">ET</span> <span class="op">+</span> <span class="va">theta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">ST</span> <span class="op">-</span> <span class="va">Pt</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="fl">4</span> <span class="op">*</span> <span class="va">ET</span> <span class="op">*</span> <span class="op">(</span><span class="va">ST</span> <span class="op">-</span> <span class="va">Pt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">deSolve</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/deSolve/man/ode.html" class="external-link">ode</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">0</span>, times <span class="op">=</span> <span class="va">time</span>, func <span class="op">=</span> <span class="va">ode_tQ</span>, parms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">kcat</span>, <span class="va">kM</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">data_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tQ_model_generate.html">tQ_model_generate</a></span><span class="op">(</span></span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.00</span>, <span class="fl">3</span>, by<span class="op">=</span><span class="fl">.05</span><span class="op">)</span>,</span>
<span>  kcat <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  kM <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  ET <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  ST <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>P_true <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">P_true</span>, <span class="fl">0.5</span><span class="op">)</span>, <span class="co"># add some observational noise</span></span>
<span>    ST <span class="op">=</span> <span class="fl">10</span>, ET <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_single</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   time    P_true         P ST ET</span></span>
<span><span class="co">## 1 0.00 0.0000000 0.4799215 10 10</span></span>
<span><span class="co">## 2 0.05 0.7311578 0.7939460 10 10</span></span>
<span><span class="co">## 3 0.10 1.4243598 2.6459084 10 10</span></span>
<span><span class="co">## 4 0.15 2.0794197 1.2737768 10 10</span></span>
<span><span class="co">## 5 0.20 2.6964485 3.2691204 10 10</span></span>
<span><span class="co">## 6 0.25 3.2758537 4.0948480 10 10</span></span></code></pre>
<p>To visualize, the true enzyme progress curve is shown in <span style="color:blue">blue</span>, and the enzyme progress curve fit to the
noisy measurements with a smooth <code>loess</code> spline is shown in
<span style="color:orange">orange</span>. While the smooth fits well, we
cannot estimate the parameters for the curve from it.</p>
<pre><code><span><span class="co">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">## â„¹ Please use `linewidth` instead.</span></span>
<span><span class="co">## This warning is displayed once every 8 hours.</span></span>
<span><span class="co">## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</span></span></code></pre>
<div class="figure" style="text-align: center">
<img src="derive_tQ_model_files/data-single-plot-1.png" alt="plot of chunk data-single-plot" width="100%"><p class="caption">
plot of chunk data-single-plot
</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-a-single-ode-observation-in-brms">Fitting a single ODE observation in BRMS<a class="anchor" aria-label="anchor" href="#fitting-a-single-ode-observation-in-brms"></a>
</h2>
<p>To implement in BRMS, we can use the <code>stanvars</code> to define
custom functions. The key idea is call the ODE solver, in this case the
backward differentiation formula (bdf) used to solve stiff ODEs, passing
a function <code>ode_tQ</code> that returns <code>dP/dt</code>, the
change in product at time <code>t</code>. The <code>ode_tQ</code>
function depends on the product at time <code>t</code> as the state
vector, the kinematic parameters to be estimated <code>kcat</code> and
<code>kM</code> and the user-provided data of the enzyme and substrate
concentrations <code>ET</code> and <code>ST</code>. To call
<code>ode_dbf</code> we pass in the initial product concentration and
time (both equal to zero), measured time-points, parameters and user
defied data. Finally we, extract the vector of sampled vector of product
concentrations which we return.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stanvars_tQ_ode</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/stanvar.html" class="external-link">stanvar</a></span><span class="op">(</span>scode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">vector tQ_ode(</span></span>
<span><span class="st">   real time,</span></span>
<span><span class="st">   vector state,</span></span>
<span><span class="st">   vector params,</span></span>
<span><span class="st">   data real ET,</span></span>
<span><span class="st">   data real ST) {</span></span>
<span><span class="st">   </span></span>
<span><span class="st">   real Pt = state[1];   // product at time t</span></span>
<span><span class="st">   real kcat = params[1];</span></span>
<span><span class="st">   real kM = params[2];</span></span>
<span><span class="st">   vector[1] dPdt;</span></span>
<span><span class="st">   dPdt[1] = kcat * (</span></span>
<span><span class="st">     ET + kM + ST - Pt</span></span>
<span><span class="st">     -sqrt((ET + kM + ST - Pt)^2 - 4 * ET * (ST - Pt))) / 2;</span></span>
<span><span class="st">   return(dPdt);</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>,</span>
<span>block <span class="op">=</span> <span class="st">"functions"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stanvars_tQ_single</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/stanvar.html" class="external-link">stanvar</a></span><span class="op">(</span>scode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">vector tQ_single(</span></span>
<span><span class="st">  data vector time,</span></span>
<span><span class="st">  vector vkcat,</span></span>
<span><span class="st">  vector vkM,</span></span>
<span><span class="st">  data vector vET,</span></span>
<span><span class="st">  data vector vST) {</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  vector[2] params = [ vkcat[1], vkM[1] ]';</span></span>
<span><span class="st">  vector[1] initial_state = [ 0.0 ]';</span></span>
<span><span class="st">  real initial_time = 0.0;</span></span>
<span><span class="st">  int M = dims(time)[1];</span></span>
<span><span class="st"></span></span>
<span><span class="st">  vector[1] P_ode[M] = ode_bdf(     // Function signature:</span></span>
<span><span class="st">    tQ_ode,                         // function ode</span></span>
<span><span class="st">    initial_state,                  // vector initial_state</span></span>
<span><span class="st">    initial_time,                   // real initial_time</span></span>
<span><span class="st">    to_array_1d(time),              // array[] real time</span></span>
<span><span class="st">    params,                         // vector params</span></span>
<span><span class="st">    vET[1],                         // ...</span></span>
<span><span class="st">    vST[1]);                        // ...</span></span>
<span><span class="st">  </span></span>
<span><span class="st">  vector[M] P;                      // Need to return a vector not array</span></span>
<span><span class="st">  for(i in 1:M) P[i] = P_ode[i,1];</span></span>
<span><span class="st">  return(P);</span></span>
<span><span class="st">}</span></span>
<span><span class="st">"</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>,</span>
<span>block <span class="op">=</span> <span class="st">"functions"</span><span class="op">)</span></span></code></pre></div>
<p>To use this function, we define <code>kcat</code> and <code>kM</code>
as parameters and that we wish to sample <code>P ~ tQ(...)</code>. Since
all the data points define a single observation, we set
<code>loop = FALSE</code>. We use <code>gamma</code> priors for
<code>kcat</code> and <code>kM</code> with the shape parameter
<code>alpha=4</code> and the rate parameter <code>beta=1</code>. The
prior mean is <code>alpha/beta = 4/1 = 4</code> and the variance is
<code>alpha/beta^2 = 4/1 = 4</code>. We also bound the parameters from
below by <code>0</code>. We initialize each chain at the prior mean and
use <code>cmdstanr</code> version 2.29.2 as the backend, and use the
default warmup of <code>1000</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">brms_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  cores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">52L</span>,</span>
<span>  backend <span class="op">=</span> <span class="st">'cmdstanr'</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="va"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">brmsformula</a></span><span class="op">(</span></span>
<span>    <span class="va">P</span> <span class="op">~</span> <span class="fu">tQ_single</span><span class="op">(</span><span class="va">time</span>, <span class="va">kcat</span>, <span class="va">kM</span>, <span class="va">ET</span>, <span class="va">ST</span><span class="op">)</span>,</span>
<span>    <span class="va">kcat</span> <span class="op">+</span> <span class="va">kM</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    nl <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    loop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_single</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="st">"kcat"</span><span class="op">)</span>,</span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="st">"kM"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  init <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>kcat <span class="op">=</span> <span class="fl">4</span>, kM <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  stanvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">stanvars_tQ_ode</span>,</span>
<span>    <span class="va">stanvars_tQ_single</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">brms_params</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ld: warning: duplicate -rpath '/Users/maom/.cmdstan/cmdstan-2.32.2/stan/lib/stan_math/lib/tbb' ignored</span></span></code></pre>
<pre><code><span><span class="co">## Start sampling</span></span></code></pre>
<pre><code><span><span class="co">## Init values were only set for a subset of parameters. </span></span>
<span><span class="co">## Missing init values for the following parameters:</span></span>
<span><span class="co">##  - chain 1: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 2: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 3: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 4: b_kcat, b_kM, sigma</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Exception: gamma_lpdf: Random variable[1] is inf, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d15dcb311.stan', line 65, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Exception: gamma_lpdf: Random variable[1] is inf, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d15dcb311.stan', line 65, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d15dcb311.stan', line 65, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 Exception: gamma_lpdf: Random variable[1] is inf, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d15dcb311.stan', line 65, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4</span></span></code></pre>
<p>Fitting the model takes ~15 seconds, with <code>Rhat = 1</code> and
effective sample size for the bulk and tail greater than
<code>1400</code> for both parameters. The estimates and 95% confidence
intervals are good.</p>
<pre><code><span><span class="co">##  Family: gaussian </span></span>
<span><span class="co">##   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">## Formula: P ~ tQ_single(time, kcat, kM, ET, ST) </span></span>
<span><span class="co">##          kcat ~ 1</span></span>
<span><span class="co">##          kM ~ 1</span></span>
<span><span class="co">##    Data: structure(list(time = c(0.05, 0.1, 0.15, 0.2, 0.25 (Number of observations: 60) </span></span>
<span><span class="co">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">##          total post-warmup draws = 4000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Population-Level Effects: </span></span>
<span><span class="co">##                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## kcat_Intercept     2.87      0.42     2.17     3.81 1.00     1301     1535</span></span>
<span><span class="co">## kM_Intercept       4.27      1.92     1.35     8.71 1.00     1282     1439</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Family Specific Parameters: </span></span>
<span><span class="co">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## sigma     0.51      0.05     0.43     0.62 1.00     1703     1668</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre>
<p>To visualize the posterior distribution vs.Â the prior distribution,
we first sample from the prior, using the same <code><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brms::brm</a></code>
call with <code>sample_prior = "only"</code> the argument.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_single_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="va"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">brmsformula</a></span><span class="op">(</span></span>
<span>    <span class="va">P</span> <span class="op">~</span> <span class="fu">tQ_single</span><span class="op">(</span><span class="va">time</span>, <span class="va">kcat</span>, <span class="va">kM</span>, <span class="va">ET</span>, <span class="va">ST</span><span class="op">)</span>,</span>
<span>    <span class="va">kcat</span> <span class="op">+</span> <span class="va">kM</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    nl <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    loop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_single</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="st">"kcat"</span><span class="op">)</span>,</span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="st">"kM"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  init <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>kcat <span class="op">=</span> <span class="fl">4</span>, kM <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  stanvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">stanvars_tQ_ode</span>,</span>
<span>    <span class="va">stanvars_tQ_single</span><span class="op">)</span>,</span>
<span>  sample_prior <span class="op">=</span> <span class="st">"only"</span><span class="op">)</span>,</span>
<span>  <span class="va">brms_params</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ld: warning: duplicate -rpath '/Users/maom/.cmdstan/cmdstan-2.32.2/stan/lib/stan_math/lib/tbb' ignored</span></span></code></pre>
<pre><code><span><span class="co">## Start sampling</span></span></code></pre>
<pre><code><span><span class="co">## Init values were only set for a subset of parameters. </span></span>
<span><span class="co">## Missing init values for the following parameters:</span></span>
<span><span class="co">##  - chain 1: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 2: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 3: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 4: b_kcat, b_kM, sigma</span></span></code></pre>
<p>And to plot, we use <code>tidybayes</code> to gather the draws and
<code>ggplot2</code> to map them to curves, with the prior as the<span style="color:orange">orange curve</span>, posterior as the <span style="color:blue">blue curve</span>, and the true parameter marked as a
vertical line.</p>
<div class="figure" style="text-align: center">
<img src="derive_tQ_model_files/prior-posterior-single-marginal-plot-1.png" alt="plot of chunk prior-posterior-single-marginal-plot" width="100%"><p class="caption">
plot of chunk prior-posterior-single-marginal-plot
</p>
</div>
Next, we plot the prior and posterior samples as a scatter plot. Note
that the high correlation of the <code>kcat</code> and <code>kM</code>
parameters in the posterior. This is expected, and typically better
estimates require varying the enzyme and substrate concentrations.
<div class="figure" style="text-align: center">
<img src="derive_tQ_model_files/prior-posterior-single-scatter-1.png" alt="plot of chunk prior-posterior-single-scatter" width="100%"><p class="caption">
plot of chunk prior-posterior-single-scatter
</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-multiple-observations">Fitting multiple observations<a class="anchor" aria-label="anchor" href="#fitting-multiple-observations"></a>
</h2>
<p>Next we will extend the BRMS model to allow fitting common
<code>kcat</code>, <code>kM</code> concentrations based on multiple
replicas, or varying substrate/enzyme concentrations using BRMS. To
demonstrate, we varying the enzyme and substrate concentrations, to
better fit the kinematic parameters.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_multiple</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  kcat <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  kM <span class="op">=</span>  <span class="fl">5</span>,</span>
<span>  ET <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>  ST <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>observation_index <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/do.html" class="external-link">do</a></span><span class="op">(</span><span class="op">{</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">.</span></span>
<span>    <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">3</span>, by<span class="op">=</span><span class="fl">.05</span><span class="op">)</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">data</span>,</span>
<span>      time <span class="op">=</span> <span class="va">time</span>,</span>
<span>      P <span class="op">=</span> <span class="fu"><a href="../reference/tQ_model_generate.html">tQ_model_generate</a></span><span class="op">(</span></span>
<span>        time <span class="op">=</span> <span class="va">time</span>,</span>
<span>        kcat <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">kcat</span>,</span>
<span>        kM <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">kM</span>,</span>
<span>        ET <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">ET</span>,</span>
<span>        ST <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">ST</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    P <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">P</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="derive_tQ_model_files/data-multiple-plot-1.png" alt="plot of chunk data-multiple-plot" width="100%"><p class="caption">
plot of chunk data-multiple-plot
</p>
</div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stanvars_tQ_multiple</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/stanvar.html" class="external-link">stanvar</a></span><span class="op">(</span>scode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">vector tQ_multiple(</span></span>
<span><span class="st">  array[] int replica,</span></span>
<span><span class="st">  data vector time,</span></span>
<span><span class="st">  vector vkcat,</span></span>
<span><span class="st">  vector vkM,</span></span>
<span><span class="st">  data vector vET,</span></span>
<span><span class="st">  data vector vST) {</span></span>
<span><span class="st"></span></span>
<span><span class="st">  int N = size(time);</span></span>
<span><span class="st">  vector[N] P;</span></span>
<span><span class="st">  int begin = 1;</span></span>
<span><span class="st">  int current_replica = replica[1];</span></span>
<span><span class="st">  for (i in 1:N){</span></span>
<span><span class="st">    if(current_replica != replica[i]){</span></span>
<span><span class="st">      P[begin:i-1] = tQ_single(</span></span>
<span><span class="st">        time[begin:i-1],</span></span>
<span><span class="st">        vkcat,</span></span>
<span><span class="st">        vkM,</span></span>
<span><span class="st">        vET[begin:i-1],</span></span>
<span><span class="st">        vST[begin:i-1]);</span></span>
<span><span class="st">      begin = i;</span></span>
<span><span class="st">      current_replica = replica[i];</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">  P[begin:N] = tQ_single(time[begin:N], vkcat, vkM, vET[begin:N], vST[begin:N]);</span></span>
<span><span class="st">  return(P);</span></span>
<span><span class="st">}"</span>, sep <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span>,</span>
<span>block <span class="op">=</span> <span class="st">"functions"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_multiple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="va"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">brmsformula</a></span><span class="op">(</span></span>
<span>    <span class="va">P</span> <span class="op">~</span> <span class="fu">tQ_multiple</span><span class="op">(</span><span class="va">observation_index</span>, <span class="va">time</span>, <span class="va">kcat</span>, <span class="va">kM</span>, <span class="va">ET</span>, <span class="va">ST</span><span class="op">)</span>,</span>
<span>    <span class="va">kcat</span> <span class="op">+</span> <span class="va">kM</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    nl <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    loop<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_multiple</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="st">"kcat"</span><span class="op">)</span>,</span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">gamma</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span>, lb <span class="op">=</span> <span class="fl">0</span>, nlpar <span class="op">=</span> <span class="st">"kM"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  init <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>kcat <span class="op">=</span> <span class="fl">4</span>, kM <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  stanvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="va">stanvars_tQ_ode</span>,</span>
<span>    <span class="va">stanvars_tQ_single</span>,</span>
<span>    <span class="va">stanvars_tQ_multiple</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">brms_params</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## ld: warning: duplicate -rpath '/Users/maom/.cmdstan/cmdstan-2.32.2/stan/lib/stan_math/lib/tbb' ignored</span></span></code></pre>
<pre><code><span><span class="co">## Start sampling</span></span></code></pre>
<pre><code><span><span class="co">## Init values were only set for a subset of parameters. </span></span>
<span><span class="co">## Missing init values for the following parameters:</span></span>
<span><span class="co">##  - chain 1: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 2: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 3: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 4: b_kcat, b_kM, sigma</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 Exception: normal_lpdf: Scale parameter is 0, but must be positive! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 104, column 4 to column 41)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 1</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 2</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Exception: gamma_lpdf: Random variable[1] is 0, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Exception: gamma_lpdf: Random variable[1] is inf, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Exception: Exception: Exception: CVode(cvodes_mem, t_final, nv_state_, &amp;t_init, CV_NORMAL) failed with error flag -4:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 Convergence test failures occurred too many times during one internal time step or minimum step size was reached. (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 23, column 4 to line 33, column 47) (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 50, column 8 to line 52, column 45) (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 103, column 4 to column 59)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 3</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 Exception: gamma_lpdf: Random variable[1] is inf, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 Exception: gamma_lpdf: Random variable[1] is inf, but must be positive finite! (in '/var/folders/w2/kpys2s194q381xp3_knz9bgc0000gs/T/Rtmpi2mqgp/model-184d125eab912.stan', line 86, column 2 to column 38)</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</span></span></code></pre>
<pre><code><span><span class="co">## Chain 4</span></span></code></pre>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_multiple</span></span></code></pre></div>
<pre><code><span><span class="co">##  Family: gaussian </span></span>
<span><span class="co">##   Links: mu = identity; sigma = identity </span></span>
<span><span class="co">## Formula: P ~ tQ_multiple(observation_index, time, kcat, kM, ET, ST) </span></span>
<span><span class="co">##          kcat ~ 1</span></span>
<span><span class="co">##          kM ~ 1</span></span>
<span><span class="co">##    Data: structure(list(kcat = c(3, 3, 3, 3, 3, 3, 3, 3, 3, (Number of observations: 540) </span></span>
<span><span class="co">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">##          total post-warmup draws = 4000</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Population-Level Effects: </span></span>
<span><span class="co">##                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## kcat_Intercept     2.78      0.04     2.70     2.87 1.00     1481     1388</span></span>
<span><span class="co">## kM_Intercept       4.44      0.31     3.86     5.09 1.00     1475     1440</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Family Specific Parameters: </span></span>
<span><span class="co">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">## sigma     0.60      0.02     0.57     0.64 1.00     1986     1783</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre>
<pre><code><span><span class="co">## Start sampling</span></span></code></pre>
<pre><code><span><span class="co">## Init values were only set for a subset of parameters. </span></span>
<span><span class="co">## Missing init values for the following parameters:</span></span>
<span><span class="co">##  - chain 1: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 2: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 3: b_kcat, b_kM, sigma</span></span>
<span><span class="co">##  - chain 4: b_kcat, b_kM, sigma</span></span></code></pre>
<div class="figure" style="text-align: center">
<img src="derive_tQ_model_files/prior-posterior-multiple-scatter-1.png" alt="plot of chunk prior-posterior-multiple-scatter" width="100%"><p class="caption">
plot of chunk prior-posterior-multiple-scatter
</p>
</div>
<p>Next we will sample enzyme progress curves from the posterior</p>
<div class="figure" style="text-align: center">
<img src="derive_tQ_model_files/model-multiple-curves-1.png" alt="plot of chunk model-multiple-curves" width="100%"><p class="caption">
plot of chunk model-multiple-curves
</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Madeline Martin, Matthew Oâ€™Meara.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
