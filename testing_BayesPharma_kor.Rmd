---
title: "KOR antagonists"
output: html_document
---


```{r}
library("Rcpp")
library("tidyverse")
library("devtools")
library("brms")
library("rstan")
library("rstantools")
library("tidybayes")
library("ggplot2")
library("readxl")
library("bayesplot")

```

```{r}
library("devtools")
load_all()
```

---
LOAD DATA

```{r}
xl_kor_antag_dr <- "C:/Users/marti/Downloads/kor_antag_dose_response_data.xlsx"

kor_antag <- readxl::read_excel(xl_kor_antag_dr)

kor_antag
```

PLOT DATA

```{r}
ggplot2::ggplot(kor_antag) +
  ggplot2::geom_point(
    aes(x = log_dose,
        y = normalized_measurement),
    size = 1.0,
    color = "black") +
  ggplot2::labs(title = "Dose Response",
       x = "Log Dose",
       y = "Response", 
       color = "Drug") + 
  ggplot2::facet_wrap(
    facets = dplyr::vars(Drug))
```

PRIORS

```{r}
kor_priors <- dr_priors(agonist = FALSE, top = 100)
kor_priors
```

INITIAL PARAMETER VALUES

```{r}
kor_inits <- dr_inits(agonist = FALSE)
kor_inits
```

SAMPLE THE PRIOR

```{r}
kor_sample_priors <- dose_response_model(kor_antag, 
                                         "normalized_measurement", 
                                         "log_dose", 
                                         "Drug",
                                         sigmoid_formula = predictors_dr_formula(),
                                         priors = kor_priors,
                                         inits = kor_inits,
                                         sample_prior = "only")
kor_sample_priors
```

```{r}
BayesPharma::plot_pp_check(kor_sample_priors)  + 
  ggplot2::xlim(-200,200) +
  ggplot2::ylim(0, 0.01)
```

VIEW THE PRIOR DISTRIBUTIONS

```{r}
prior_densities(kor_sample_priors)
```

RUN BAYESIAN MODEL

```{r}
kor_model <- dose_response_model(kor_antag, 
                                 "normalized_measurement", 
                                 "log_dose", 
                                 "Drug",
                                 sigmoid_formula = predictors_dr_formula(),
                                 priors = kor_priors,
                                 inits = kor_inits)

kor_model
```

CHECK MODEL CONVERGENCE

```{r}
BayesPharma::traceplot(kor_model) 
```

POSTERIOR PREDICTIVE CHECK

```{r}
BayesPharma::plot_pp_check(kor_model,
                           "dens_overlay_grouped", 
                           group = 'predictors',
                           n = 50)
```

PRIOR POSTERIOR PARAMETER DENSITY DISTRIBUTIONS

```{r}
prior_posterior_densities(kor_model)
```

POSTERIOR PARAMETER DENSITY DISTRIBUTIONS

```{r}
posterior_densities(kor_model)
```

SAMPLE OF DOSE RESPONSE CURVES FROM THE POSTERIOR DISTRIBUTION

```{r}

BayesPharma::plot_draws_data(model = kor_model,
                            n = 100,
                            lower = -12,
                            upper = -3,
                            predictor_name = NULL,
                            data = kor_antag,
                            predictors_col_name = "Drug",
                            measurement = kor_antag$normalized_measurement,
                            draws,
                            pred_response,
                            mean_draws,
                            title = NULL,
                            xlabel = "Log Dose",
                            ylabel = "Response"
                             )
```

---
IMPROVING THE MODEL BY MAKING MORE INFORMATIVE PRIORS PRIORS

```{r}
kor_priors2 <- BayesPharma::dr_priors(ec50 = brms::prior(normal(-8, 1.5), 
                                                         nlpar = "ec50"),
                                      hill = brms::prior(normal(-1,0.5), 
                                                         lb = -2.01, 
                                                         ub = 0.01, 
                                                         nlpar = "hill"),
                                      top = 100,
                                      bottom = brms::prior(normal(10,10), 
                                                           nlpar = "bottom"))
kor_priors2
```

SAMPLE THE PRIOR

```{r}
kor_sample_priors <- dose_response_model(kor_antag, 
                                         "normalized_measurement", 
                                         "log_dose", 
                                         "Drug",
                                         sigmoid_formula = predictors_dr_formula(),
                                         priors = kor_priors2,
                                         inits = kor_inits,
                                         sample_prior = "only")
kor_sample_priors
```

VIEW THE PRIOR DISTRIBUTIONS

```{r}
prior_densities(kor_sample_priors)
```

RUN BAYESIAN MODEL

```{r}
kor_model2 <- dose_response_model(kor_antag, 
                                  "normalized_measurement", 
                                  "log_dose", 
                                  "Drug",
                                  sigmoid_formula = predictors_dr_formula(),
                                  priors = kor_priors2,
                                  inits = kor_inits)

kor_model2
```


CHECK MODEL CONVERGENCE

```{r}
BayesPharma::traceplot(kor_model2) 
```

POSTERIOR PREDICTIVE CHECK

```{r}
BayesPharma::plot_pp_check(kor_model2,
                           "dens_overlay_grouped", 
                           group = 'predictors',
                           n = 50)
```

PRIOR POSTERIOR PARAMETER DENSITY DISTRIBUTIONS

```{r}
prior_posterior_densities(kor_model2)
```

POSTERIOR PARAMETER DENSITY DISTRIUBTIONS

```{r}
posterior_densities(kor_model2)
```

SAMPLE OF DOSE RESPONSE CURVES FROM THE POSTERIOR DISTRIBUTION

```{r}

BayesPharma::plot_draws_data(model = kor_model2,
                            n = 100,
                            lower = -12,
                            upper = -3,
                            predictor_name = NULL,
                            data = kor_antag,
                            predictors_col_name = "Drug",
                            measurement = kor_antag$normalized_measurement,
                            draws,
                            pred_response,
                            mean_draws,
                            title = NULL,
                            xlabel = "Log Dose",
                            ylabel = "Response"
                             )
```

COMPARE THE MODELS

```{r}
kor_model <- add_loo_criterion(kor_model, 3)
kor_model2 <- add_loo_criterion(kor_model2, 3)
compare_models(kor_model, kor_model2)
```



---
ANALYSIS USING DRC

```{r}
library("drc") 
# https://rstats4ag.org/dose-response-curves.html#one-dose-response-curve
```

```{r}
kor_antag
```

```{r}
BTRX_335140_df <- kor_antag[grepl("BTRX_335140", kor_antag$Drug),]
BTRX_395750_df <- kor_antag[grepl("BTRX_395750", kor_antag$Drug),]
JNJ_df <- kor_antag[grepl("JNJ", kor_antag$Drug),]
PF_df <- kor_antag[grepl("PF", kor_antag$Drug),]
```


```{r}
BTRX_335140_drc <- drm(normalized_measurement ~ log_dose,
                       data = BTRX_335140_df,
                       fct = L.4(fixed = c(NA, NA, 100, NA),
                                 names = c("hill", "bottom", "top", "ec50")))

BTRX_395750_drc <- drm(normalized_measurement ~ log_dose,
                       data = BTRX_395750_df,
                       fct = L.4(fixed = c(NA, NA, 100, NA),
                                 names = c("hill", "bottom", "top", "ec50")))

JNJ_drc <- drm(normalized_measurement ~ log_dose,
                       data = JNJ_df,
                       fct = L.4(fixed = c(NA, NA, 100, NA),
                                 names = c("hill", "bottom", "top", "ec50")))

PF_drc <- drm(normalized_measurement ~ log_dose,
                       data = PF_df,
                       fct = L.4(fixed = c(NA, NA, 100, NA),
                                 names = c("hill", "bottom", "top", "ec50")))

summary(BTRX_335140_drc)
summary(BTRX_395750_drc)
summary(JNJ_drc)
summary(PF_drc)

```

```{r}

plot(BTRX_335140_drc,
     log = "", 
     type = c("average"), 
     xlim = c(-11, -6),
     ylim = c(-50,150),
     col = "red",
     pch = 16)
plot(BTRX_335140_drc, 
     add = TRUE,
     log = "", 
     type = c("all"), 
     xlim = c(-11, -6),
     ylim = c(-50,150),
     col = "gray",
     pch = 16)
plot(BTRX_335140_drc, 
     add = TRUE,
     log = "", 
     type = c("bars"), 
     xlim = c(-11, -6),
     ylim = c(-50,150),
     col = "black",
     lty = 1)
```

```{r}
log_dose <- seq(min(-4), max(-12), length.out=100)

BTRX_335140_pred_value <- predict(BTRX_335140_drc, expand.grid(log_dose, 1))
BTRX_335140_drc_df <- data.frame(log_dose, BTRX_335140_pred_value)

BTRX_395750_pred_value <- predict(BTRX_395750_drc, expand.grid(log_dose, 1))
BTRX_395750_drc_df <- data.frame(log_dose, BTRX_395750_pred_value)

JNJ_pred_value <- predict(JNJ_drc, expand.grid(log_dose, 1))
JNJ_drc_df <- data.frame(log_dose, JNJ_pred_value)

PF_pred_value <- predict(PF_drc, expand.grid(log_dose, 1))
PF_drc_df <- data.frame(log_dose, PF_pred_value)


```
```{r}
plot_drc <- function(drc_df, 
                     pred_value,
                     data,
                     title,
                     values = colors) {
  ggplot2::ggplot(drc_df) +
    ggplot2::geom_line(mapping = ggplot2::aes(x = log_dose, 
                                              y = pred_value,
                                              color = "drc"),
                       size = 0.6) +
    ggplot2::geom_point(data = data, 
                        mapping = ggplot2::aes(x = log_dose, 
                                               y = normalized_measurement)) +

    ggplot2::labs(title = title,
                  color = "Fit") + 
    ggplot2::xlab("log dose") +
    ggplot2::ylab("response") +
    ggplot2::scale_color_manual(values = values)
}

kor_post_means <- BayesPharma::posterior_mean(kor_model2,
                                              n = 100,
                                              lower = -12,
                                              upper = -4,
                                              predictor_name = NULL) 

colors = c("drc" = "blue", "Bayes" = "red")



BTRX_335140_drc_plot <- plot_drc(BTRX_335140_drc_df, 
                                 BTRX_335140_pred_value,
                                 BTRX_335140_df,
                                 "BTRX_335140") +
  ggplot2::geom_line(data = kor_post_means[grepl("BTRX_335", kor_post_means$predictors),],
                     mapping = ggplot2::aes(x = log_dose, 
                                            y = Response,
                                            color = "Bayes"),
                     size = 0.6)

BTRX_395750_drc_plot <- plot_drc(BTRX_395750_drc_df, 
                                 BTRX_395750_pred_value,
                                 BTRX_395750_df,
                                 "BTRX_395750") +
  ggplot2::geom_line(data = kor_post_means[grepl("BTRX_395", kor_post_means$predictors),],
                     mapping = ggplot2::aes(x = log_dose, 
                                            y = Response,
                                            color = "Bayes"),
                     size = 0.6)

JNJ_drc_plot <- plot_drc(JNJ_drc_df, 
                         JNJ_pred_value,
                         JNJ_df,
                         "JNJ") +
  ggplot2::geom_line(data = kor_post_means[grepl("JNJ", kor_post_means$predictors),],
                     mapping = ggplot2::aes(x = log_dose, 
                                            y = Response,
                                            color = "Bayes"),
                     size = 0.6)

PF_drc_plot <- plot_drc(PF_drc_df, 
                        PF_pred_value,
                        PF_df,
                        "PF") +
  ggplot2::geom_line(data = kor_post_means[grepl("PF", kor_post_means$predictors),],
                     mapping = ggplot2::aes(x = log_dose, 
                                            y = Response,
                                            color = "Bayes"),
                     size = 0.6)
                    

BTRX_335140_drc_plot
BTRX_395750_drc_plot
JNJ_drc_plot
PF_drc_plot
```

```{r}

drc_stats <- function(drc_fit) {
  
  data.frame(variables = c("hill", "bottom", "ec50")) %>%
    dplyr::mutate(
      mean = summary(drc_fit)$coefficients[, 1],
      std_error = summary(drc_fit)$coefficients[, 2],
      l_ci = summary(drc_fit)$coefficients[, 1] - summary(drc_fit)$coefficients[, 2],
      u_ci = summary(drc_fit)$coefficients[, 1] + summary(drc_fit)$coefficients[, 2],
      t_value = summary(drc_fit)$coefficients[, 3],
      p_value = summary(drc_fit)$coefficients[, 4],
      model = "drc"
      )
  
}

BTRX_335140_drc_stats <- drc_stats(BTRX_335140_drc)

BTRX_395750_drc_stats <- drc_stats(BTRX_395750_drc)

JNJ_drc_stats <- drc_stats(JNJ_drc)

PF_drc_stats <- drc_stats(PF_drc)

BTRX_335140_drc_stats
BTRX_395750_drc_stats
JNJ_drc_stats
PF_drc_stats
```

```{r}

basic_stats(kor_model2)

```

```{r}

BTRX_335140_bayes_stats <-
  basic_stats(kor_model2)[grepl("BTRX_335140", basic_stats(kor_model2)$variables),] %>%
  dplyr::mutate(variables = stringr::str_extract(variables,
                                                 "[a-zA-Z0-9]+.{1,100}") %>%
                    stringr::str_remove("_BTRX_335140"),
                model = "Bayes")

BTRX_395750_bayes_stats <-
  basic_stats(kor_model2)[grepl("BTRX_395750", basic_stats(kor_model2)$variables),]%>%
  dplyr::mutate(variables = stringr::str_extract(variables,
                                                 "[a-zA-Z0-9]+.{1,100}") %>%
                    stringr::str_remove("_BTRX_395750"),
                model = "Bayes")

JNJ_bayes_stats <-
  basic_stats(kor_model2)[grepl("JNJ", basic_stats(kor_model2)$variables),] %>%
  dplyr::mutate(variables = stringr::str_extract(variables,
                                                 "[a-zA-Z0-9]+.{1,100}") %>%
                    stringr::str_remove("_JNJ"),
                model = "Bayes")

PF_bayes_stats <-
  basic_stats(kor_model2)[grepl("PF", basic_stats(kor_model2)$variables),] %>%
  dplyr::mutate(variables = stringr::str_extract(variables,
                                                 "[a-zA-Z0-9]+.{1,100}") %>%
                    stringr::str_remove("_PF"),
                model = "Bayes")

BTRX_395750_bayes_stats[1:3,]
```

```{r}
model = c("drc" = "blue", "Bayes" = "red")

dplyr::bind_rows(BTRX_335140_drc_stats, BTRX_335140_bayes_stats[1:3,]) %>%
  ggplot2::ggplot(aes(y = variables, x = mean, xmin = l_ci, xmax = u_ci, color = model)) +
  ggdist::geom_pointinterval(position = position_dodge(width = .3)) +
  ggplot2::scale_color_manual(values = model) +
  ggplot2::labs(title = "BTRX_335140")
```

```{r}
dplyr::bind_rows(BTRX_395750_drc_stats, BTRX_395750_bayes_stats[1:3,]) %>%
  ggplot2::ggplot(aes(y = variables, x = mean, xmin = l_ci, xmax = u_ci, color = model)) +
  ggdist::geom_pointinterval(position = position_dodge(width = .3)) +
  ggplot2::scale_color_manual(values = model) +
  ggplot2::labs(title = "BTRX_395750")
```

```{r}
dplyr::bind_rows(JNJ_drc_stats, JNJ_bayes_stats[1:3,]) %>%
  ggplot2::ggplot(aes(y = variables, x = mean, xmin = l_ci, xmax = u_ci, color = model)) +
  ggdist::geom_pointinterval(position = position_dodge(width = .3)) +
  ggplot2::scale_color_manual(values = model) +
  ggplot2::labs(title = "JNJ")
```

```{r}
dplyr::bind_rows(PF_drc_stats, PF_bayes_stats[1:3,]) %>%
  ggplot2::ggplot(aes(y = variables, x = mean, xmin = l_ci, xmax = u_ci, color = model)) +
  ggdist::geom_pointinterval(position = position_dodge(width = .3)) +
  ggplot2::scale_color_manual(values = model) +
  ggplot2::labs(title = "PF")
```

