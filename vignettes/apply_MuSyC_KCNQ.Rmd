---
title: "Apply: MuSyC Model -- KCNQ Conductance"
description: Demonstrate the MuSyC_model to analyze the interaction between
  voltage and small molecules interact modulate conductance through the KCNQ2
  voltage gated potassium channel.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Apply: MuSyC Model -- KCNQ Conductance}
  %\VignetteEncoding{UTF-8}
---








```r
read_range <- function(
    sheet,
    range,
    treatment,
    dose_uM,
    is_control){
  readxl::read_excel(
    path = here::here(
      "inst", "extdata", "conductance_KCNQ", "Li_CellRes_2021_fig1.xlsx"),
    sheet = {{sheet}},
    range = range,
    col_names = FALSE,
    .name_repair = ~ paste0("replica_", 1:length(.))) |>
    dplyr::mutate(
      treatment = {{treatment}},
      dose_uM = {{dose_uM}},
      is_control = {{is_control}},
      voltage = seq(-90, 60, by = 10),
      .before = 1) |>
    tidyr::pivot_longer(
      cols = c(-treatment, -dose_uM, -is_control, -voltage),
      names_to = "replica",
      values_to = "conductance")
}

data <- dplyr::bind_rows(
  read_range(
    sheet = "fig1b", range = "E3:I18",
    treatment = "ztz240", dose_uM = 10, is_control = TRUE),
  read_range(
    sheet = "fig1b", range = "L3:P18",
    treatment = "ztz240", dose_uM = 10, is_control = FALSE),
  read_range(
    sheet = "fig1b", range = "E22:I37",
    treatment = "ztz240", dose_uM = 5, is_control = TRUE),
  read_range(
    sheet = "fig1b", range = "L22:P37",
    treatment = "ztz240", dose_uM = 5, is_control = FALSE),  
  read_range(
    sheet = "fig1b", range = "E40:I55",
    treatment = "ztz240", dose_uM = 3, is_control = TRUE),
  read_range(
    sheet = "fig1b", range = "L40:P55",
    treatment = "ztz240", dose_uM = 3, is_control = FALSE), 
  read_range(
    sheet = "fig1b", range = "E58:J73",
    treatment = "ztz240", dose_uM = 1, is_control = TRUE),
  read_range(
    sheet = "fig1b", range = "L58:Q73",
    treatment = "ztz240", dose_uM = 1, is_control = FALSE),   
  read_range(
    sheet = "fig1b", range = "E77:I92",
    treatment = "ztz240", dose_uM = 0.1, is_control = TRUE),
  read_range(
    sheet = "fig1b", range = "L77:P92",
    treatment = "ztz240", dose_uM = 0.1, is_control = FALSE),

  read_range(
    sheet = "fig 1d", range = "D2:I17",
    treatment = "retigabine", dose_uM = 30, is_control = TRUE),
  read_range(
    sheet = "fig 1d", range = "M2:R17",
    treatment = "retigabine", dose_uM = 30, is_control = FALSE),
  read_range(
    sheet = "fig 1d", range = "D20:I35",
    treatment = "retigabine", dose_uM = 10, is_control = TRUE),
  read_range(
    sheet = "fig 1d", range = "M20:R35",
    treatment = "retigabine", dose_uM = 10, is_control = FALSE),  
  read_range(
    sheet = "fig 1d", range = "D39:H54",
    treatment = "retigabine", dose_uM = 5, is_control = TRUE),
  read_range(
    sheet = "fig 1d", range = "M39:Q54",
    treatment = "retigabine", dose_uM = 5, is_control = FALSE), 
  read_range(
    sheet = "fig 1d", range = "D57:H72",
    treatment = "retigabine", dose_uM = 3, is_control = TRUE),
  read_range(
    sheet = "fig 1d", range = "M57:Q72",
    treatment = "retigabine", dose_uM = 3, is_control = FALSE),   
  read_range(
    sheet = "fig 1d", range = "D76:H91",
    treatment = "retigabine", dose_uM = 1, is_control = TRUE),
  read_range(
    sheet = "fig 1d", range = "M76:Q91",
    treatment = "retigabine", dose_uM = 1, is_control = FALSE),
  read_range(
    sheet = "fig 1d", range = "D95:H110",
    treatment = "retigabine", dose_uM = 0.3, is_control = TRUE),
  read_range(
    sheet = "fig 1d", range = "M95:Q110",
    treatment = "retigabine", dose_uM = 0.3, is_control = FALSE))
```






```
## Coordinate system already present. Adding new coordinate system, which will
## replace the existing one.
```

```
## Error in check_breaks_labels(breaks, labels): object 'd2_label' not found
```




```r
model_conductance <- BayesPharma::sigmoid_model(
  data = model_data,
  formula = BayesPharma::sigmoid_agonist_formula(
    treatment_variable = "voltage",
    treatment_units = "mV",
    response_variable = "conductance",
    response_units = "% Gmax",
    predictors = 0 + treatment:doselabel),
  prior = BayesPharma::sigmoid_agonist_prior(
    ec50 = brms::prior(normal(-0.2, 1), nlpar = "ec50"),
    hill = brms::prior(normal(3, 2), nlpar = "hill", lb = 1)),
  cores = 4)
```


```r
model_conductance |>
  BayesPharma::plot_prior_posterior_densities()
```

```
## 
## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 1).
## Chain 1: 
## Chain 1: Gradient evaluation took 1.5e-05 seconds
## Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 0.15 seconds.
## Chain 1: Adjust your expectations accordingly!
## Chain 1: 
## Chain 1: 
## Chain 1: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 1: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 1: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 1: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 1: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 1: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 1: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 1: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 1: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 1: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 1: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 1: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 1: 
## Chain 1:  Elapsed Time: 0.147 seconds (Warm-up)
## Chain 1:                0.224 seconds (Sampling)
## Chain 1:                0.371 seconds (Total)
## Chain 1: 
## 
## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 2).
## Chain 2: 
## Chain 2: Gradient evaluation took 4e-06 seconds
## Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 0.04 seconds.
## Chain 2: Adjust your expectations accordingly!
## Chain 2: 
## Chain 2: 
## Chain 2: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 2: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 2: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 2: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 2: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 2: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 2: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 2: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 2: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 2: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 2: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 2: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 2: 
## Chain 2:  Elapsed Time: 0.159 seconds (Warm-up)
## Chain 2:                0.172 seconds (Sampling)
## Chain 2:                0.331 seconds (Total)
## Chain 2: 
## 
## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 3).
## Chain 3: 
## Chain 3: Gradient evaluation took 3e-06 seconds
## Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.
## Chain 3: Adjust your expectations accordingly!
## Chain 3: 
## Chain 3: 
## Chain 3: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 3: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 3: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 3: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 3: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 3: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 3: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 3: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 3: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 3: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 3: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 3: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 3: 
## Chain 3:  Elapsed Time: 0.149 seconds (Warm-up)
## Chain 3:                0.11 seconds (Sampling)
## Chain 3:                0.259 seconds (Total)
## Chain 3: 
## 
## SAMPLING FOR MODEL 'anon_model' NOW (CHAIN 4).
## Chain 4: 
## Chain 4: Gradient evaluation took 3e-06 seconds
## Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 0.03 seconds.
## Chain 4: Adjust your expectations accordingly!
## Chain 4: 
## Chain 4: 
## Chain 4: Iteration:    1 / 2000 [  0%]  (Warmup)
## Chain 4: Iteration:  200 / 2000 [ 10%]  (Warmup)
## Chain 4: Iteration:  400 / 2000 [ 20%]  (Warmup)
## Chain 4: Iteration:  600 / 2000 [ 30%]  (Warmup)
## Chain 4: Iteration:  800 / 2000 [ 40%]  (Warmup)
## Chain 4: Iteration: 1000 / 2000 [ 50%]  (Warmup)
## Chain 4: Iteration: 1001 / 2000 [ 50%]  (Sampling)
## Chain 4: Iteration: 1200 / 2000 [ 60%]  (Sampling)
## Chain 4: Iteration: 1400 / 2000 [ 70%]  (Sampling)
## Chain 4: Iteration: 1600 / 2000 [ 80%]  (Sampling)
## Chain 4: Iteration: 1800 / 2000 [ 90%]  (Sampling)
## Chain 4: Iteration: 2000 / 2000 [100%]  (Sampling)
## Chain 4: 
## Chain 4:  Elapsed Time: 0.171 seconds (Warm-up)
## Chain 4:                0.128 seconds (Sampling)
## Chain 4:                0.299 seconds (Total)
## Chain 4:
```

<img src="apply_MuSyC_KCNQ_files/model-conductance-prior-posterior-1.png" alt="plot of chunk model-conductance-prior-posterior" width="100%" style="display: block; margin: auto;" />


```r
model_conductance |>
  BayesPharma::plot_posterior_draws()
```

<img src="apply_MuSyC_KCNQ_files/model-conductance-predictive-1.png" alt="plot of chunk model-conductance-predictive" width="100%" style="display: block; margin: auto;" />
Fit MuSyC Model


```
## Warning in BayesPharma::MuSyC_model(data = model_data, formula = BayesPharma::MuSyC_formula(treatment_1_variable = "voltage", : There needs to be variable for treatment 2 'log_dose' as a column in the input 'data' data.frame
```

```
## Error in `dplyr::mutate()`:
## ℹ In argument: `logd2scale = mean(.data[["log_dose"]])`.
## Caused by error in `.data[["log_dose"]]`:
## ! Column `log_dose` not found in `.data`.
```

```
## Error in stanc(file = file, model_code = model_code, model_name = model_name, : 0
## 
## Semantic error in 'string', line 84, column 24 to column 27:
## 
## Identifier 'Inf' not in scope.
```

Join the conductance model with the dose information to model how the voltage
dependence depends on the drug dose

```
## # A tibble: 44 × 15
##    variable_type variable predictors_label         mean   median      sd     mad
##    <chr>         <chr>    <chr>                   <dbl>    <dbl>   <dbl>   <dbl>
##  1 b             ec50     treatmentztz240:dos… -0.116   -0.117   0.0145  0.0145 
##  2 b             ec50     treatmentretigabine… -0.189   -0.189   0.0118  0.0118 
##  3 b             ec50     treatmentretigabine… -0.247   -0.247   0.0141  0.0139 
##  4 b             ec50     treatmentztz240:dos… -0.194   -0.194   0.0117  0.0117 
##  5 b             ec50     treatmentretigabine… -0.451   -0.450   0.0139  0.0136 
##  6 b             ec50     treatmentztz240:dos… -0.438   -0.438   0.00822 0.00809
##  7 b             ec50     treatmentretigabine… -0.356   -0.356   0.0125  0.0123 
##  8 b             ec50     treatmentztz240:dos… -0.322   -0.322   0.0108  0.0109 
##  9 b             ec50     treatmentretigabine… -0.430   -0.430   0.0135  0.0134 
## 10 b             ec50     treatmentretigabine… -0.398   -0.398   0.0122  0.0122 
## 11 b             ec50     treatmentztz240:dos… -0.321   -0.322   0.00981 0.00973
## 12 b             hill     treatmentztz240:dos…  2.48     2.47    0.208   0.209  
## 13 b             hill     treatmentretigabine…  3.03     3.02    0.244   0.241  
## 14 b             hill     treatmentretigabine…  2.56     2.56    0.214   0.212  
## 15 b             hill     treatmentztz240:dos…  2.85     2.85    0.212   0.209  
## 16 b             hill     treatmentretigabine…  2.89     2.88    0.239   0.239  
## 17 b             hill     treatmentztz240:dos…  4.99     4.97    0.433   0.427  
## 18 b             hill     treatmentretigabine…  3.12     3.11    0.269   0.268  
## 19 b             hill     treatmentztz240:dos…  3.39     3.38    0.270   0.267  
## 20 b             hill     treatmentretigabine…  2.77     2.77    0.219   0.214  
## 21 b             hill     treatmentretigabine…  3.12     3.11    0.256   0.258  
## 22 b             hill     treatmentztz240:dos…  3.88     3.86    0.297   0.293  
## 23 b             top      treatmentztz240:dos…  0.994    0.994   0.0216  0.0214 
## 24 b             top      treatmentretigabine…  0.969    0.969   0.0156  0.0154 
## 25 b             top      treatmentretigabine…  0.980    0.979   0.0168  0.0167 
## 26 b             top      treatmentztz240:dos…  0.927    0.926   0.0149  0.0146 
## 27 b             top      treatmentretigabine…  0.964    0.964   0.0113  0.0113 
## 28 b             top      treatmentztz240:dos…  0.932    0.932   0.00962 0.00973
## 29 b             top      treatmentretigabine…  0.950    0.950   0.0129  0.0129 
## 30 b             top      treatmentztz240:dos…  0.965    0.964   0.0127  0.0127 
## 31 b             top      treatmentretigabine…  0.964    0.964   0.0120  0.0119 
## 32 b             top      treatmentretigabine…  0.962    0.962   0.0125  0.0125 
## 33 b             top      treatmentztz240:dos…  0.952    0.952   0.0115  0.0114 
## 34 b             bottom   treatmentztz240:dos…  0.0107   0.0112  0.0182  0.0178 
## 35 b             bottom   treatmentretigabine…  0.0194   0.0199  0.0172  0.0169 
## 36 b             bottom   treatmentretigabine…  0.00380  0.00488 0.0224  0.0222 
## 37 b             bottom   treatmentztz240:dos… -0.0210  -0.0205  0.0167  0.0165 
## 38 b             bottom   treatmentretigabine… -0.0378  -0.0358  0.0307  0.0296 
## 39 b             bottom   treatmentztz240:dos… -0.00425 -0.00388 0.0184  0.0183 
## 40 b             bottom   treatmentretigabine… -0.0112  -0.0104  0.0232  0.0232 
## 41 b             bottom   treatmentztz240:dos… -0.0180  -0.0174  0.0195  0.0192 
## 42 b             bottom   treatmentretigabine… -0.0707  -0.0689  0.0297  0.0288 
## 43 b             bottom   treatmentretigabine… -0.0505  -0.0492  0.0255  0.0251 
## 44 b             bottom   treatmentztz240:dos…  0.00339  0.00371 0.0172  0.0170 
## # ℹ 8 more variables: q5 <dbl>, q95 <dbl>, rhat <dbl>, ess_bulk <dbl>,
## #   ess_tail <dbl>, treatment <chr>, logdose <dbl>, doselabel <fct>
```


<img src="apply_MuSyC_KCNQ_files/plot-voltage-by-dose-1.png" alt="plot of chunk plot-voltage-by-dose" width="100%" style="display: block; margin: auto;" />





```
##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: conductance ~ sigmoid(sigmoid(Eec50, Ehill, Etop, Ebottom, logdose), sigmoid(Hec50, Hhill, Htop, Hbottom, logdose), vtop, vbottom, voltage) 
##          vtop ~ 1
##          vbottom ~ 1
##          Eec50 ~ 0 + treatment
##          Ehill ~ 0 + treatment
##          Etop ~ 0 + treatment
##          Ebottom ~ 0 + treatment
##          Hec50 ~ 0 + treatment
##          Hhill ~ 0 + treatment
##          Htop ~ 0 + treatment
##          Hbottom ~ 0 + treatment
##    Data: model_data (Number of observations: 928) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Population-Level Effects: 
##                             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
## vtop_Intercept                  0.95      0.00     0.95     0.96 1.00     4873
## vbottom_Intercept              -0.00      0.01    -0.01     0.01 1.00     4343
## Eec50_treatmentretigabine      -5.77      0.07    -5.93    -5.64 1.00     2021
## Eec50_treatmentztz240          -5.46      0.06    -5.56    -5.34 1.00     2316
## Ehill_treatmentretigabine      -1.61      0.27    -2.18    -1.10 1.00     1722
## Ehill_treatmentztz240          -1.45      0.18    -1.83    -1.14 1.00     2199
## Etop_treatmentretigabine       -0.19      0.02    -0.22    -0.14 1.00     1747
## Etop_treatmentztz240           -0.14      0.01    -0.15    -0.12 1.00     3961
## Ebottom_treatmentretigabine    -0.43      0.01    -0.44    -0.41 1.00     2889
## Ebottom_treatmentztz240        -0.48      0.03    -0.54    -0.44 1.00     1926
## Hec50_treatmentretigabine      -3.94      1.77    -8.05    -0.54 1.00     1080
## Hec50_treatmentztz240          -5.14      0.22    -5.52    -4.70 1.00     1964
## Hhill_treatmentretigabine       1.24      0.73     0.25     3.01 1.00     2342
## Hhill_treatmentztz240           1.77      0.49     1.02     2.93 1.00     2507
## Htop_treatmentretigabine        4.50      1.60     2.46     8.27 1.00     1944
## Htop_treatmentztz240            5.85      1.17     4.27     8.74 1.00     2066
## Hbottom_treatmentretigabine     2.99      0.09     2.82     3.15 1.00     2568
## Hbottom_treatmentztz240         2.83      0.08     2.68     3.00 1.00     4100
##                             Tail_ESS
## vtop_Intercept                  2666
## vbottom_Intercept               3061
## Eec50_treatmentretigabine       1220
## Eec50_treatmentztz240           2382
## Ehill_treatmentretigabine       1113
## Ehill_treatmentztz240           2451
## Etop_treatmentretigabine        1144
## Etop_treatmentztz240            2612
## Ebottom_treatmentretigabine     1680
## Ebottom_treatmentztz240         2191
## Hec50_treatmentretigabine       1698
## Hec50_treatmentztz240           1923
## Hhill_treatmentretigabine       2038
## Hhill_treatmentztz240           2884
## Htop_treatmentretigabine        2328
## Htop_treatmentztz240            2080
## Hbottom_treatmentretigabine     3042
## Hbottom_treatmentztz240         3017
## 
## Family Specific Parameters: 
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.06      0.00     0.06     0.06 1.00     4505     3010
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).
```





```
## Error in brms::loo_compare(model_MuSyC, model_bilevel): object 'model_MuSyC' not found
```

