---
title: "Apply: MuSyC Model -- KCNQ Conductance"
description: Demonstrate the MuSyC_model to analyze the interaction between
  voltage and small molecules interact modulate conductance through the KCNQ2
  voltage gated potassium channel.
output: rmarkdown::html_vignette
bibliography: references.bib
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Apply: MuSyC Model -- KCNQ Conductance}
  %\VignetteEncoding{UTF-8}
---

<style type="text/css">

code.r{
  font-size: 9px;
}
pre {
  font-size: 9px
}
</style>








# Re-analysis Figure 1 of (Li, et al., 2021) Molecular Basis for Ligand Activation of the Human KCNQ2 Channel

KCNQ2 is a voltage gated potassium channel important for re-establishing neuronal homeostasis following an action potential. Dis-regulation of channels in the KCNQ family can cause epilepsy, tinnitus, and depression. While there has been sustained interest in developing small-molecule based therapeutics targeting KCNQ2, the only FDA approved drug that targets KCNQ2, retigabine, was given a black-box warning due to unwanted side-effects, even though it was effective at treating epilepsy. Excitingly there has been recent progress in using Cryo-EM to structurally characterize ion channels including KCNQ2, which promise to support structure-based drug design.

Recently, [@Li2021-ef] used Cryo-EM to characterize the structure of KCNQ2 in complex with retigabine, which interacts in the membrane on the outside of the pore, and ztz240, which interacts with the voltage sensor domain. To relate the structure and function, [@Li2021-ef] measured conductance as a function of voltage (G-V curves) in the presence of varying doses of retigabine and ztz240 using whole cell patch-clamp electrophysiology in Chinese hamster ovary (CHO)-K1 cells overexpressing KCNQ2. Both compounds are thought to be agonists, that is with increasing concentration of drug, less negative voltages are required to open the channel.

In this case study, the aim is to re-analyze the effects of retigabine and ztz240 using the data collected in [@Li2021-ef] and presented in panels B and D of figure 1. A key idea is to recognize that voltage and drug treatment can be thought of independent perturbations and the drug effect can be framed as characterizing the interaction between these perturbations.

To begin, we will load and plot the data,


```
## # A tibble: 1,856 × 6
##    treatment dose_uM is_control voltage replica   conductance
##    <chr>       <dbl> <lgl>        <dbl> <chr>           <dbl>
##  1 ztz240         10 TRUE           -90 replica_1      0.0403
##  2 ztz240         10 TRUE           -90 replica_2      0.0632
##  3 ztz240         10 TRUE           -90 replica_3      0.0200
##  4 ztz240         10 TRUE           -90 replica_4      0.0404
##  5 ztz240         10 TRUE           -90 replica_5      0.0175
##  6 ztz240         10 TRUE           -80 replica_1      0.0469
##  7 ztz240         10 TRUE           -80 replica_2      0.0682
##  8 ztz240         10 TRUE           -80 replica_3      0.0345
##  9 ztz240         10 TRUE           -80 replica_4      0.0574
## 10 ztz240         10 TRUE           -80 replica_5      0.0339
## # ℹ 1,846 more rows
```
\normalsize

<div class="figure" style="text-align: center">
<img src="apply_MuSyC_KCNQ_files/reproduce-fig1-1.png" alt="Reproduction of Figure 1b and 1d from (Li, et al., 2021)" width="100%" />
<p class="caption">Reproduction of Figure 1b and 1d from (Li, et al., 2021)</p>
</div>
Then, for each treatment and dose, we will fit a sigmoid curve, which has an comparable functional form to the what they call the Boltzmann equation for G/Gmax as a function of voltage. To make the fitting more stable, we will transform the treatment and response scales.




```r
model_conductance <- BayesPharma::sigmoid_model(
  data = model_data,
  formula = BayesPharma::sigmoid_agonist_formula(
    treatment_variable = "voltage",
    treatment_units = "mV",
    response_variable = "conductance",
    response_units = "% Gmax",
    predictors = 0 + treatment:doselabel),
  prior = BayesPharma::sigmoid_agonist_prior(
    ec50 = brms::prior(normal(-0.2, 1), nlpar = "ec50"),
    hill = brms::prior(normal(3, 2), nlpar = "hill", lb = 0)),
  init = BayesPharma::sigmoid_agonist_init(
    ec50 = \() runif(1, min = -7, max = -5),
    hill = \() runif(1, min = 0.8, max = 1.2),
    bottom = \() runif(1, min = -.1, max = 0.1),
    top = \() runif(1, min = 0.8, max = 1.2)),
  cores = 4)
```

```
##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: conductance ~ sigmoid(ec50, hill, top, bottom, voltage) 
##          ec50 ~ 0 + treatment:doselabel
##          hill ~ 0 + treatment:doselabel
##          top ~ 0 + treatment:doselabel
##          bottom ~ 0 + treatment:doselabel
##    Data: data (Number of observations: 928) 
##   Draws: 4 chains, each with iter = 8000; warmup = 4000; thin = 1;
##          total post-warmup draws = 16000
## 
## Regression Coefficients:
##                                           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## ec50_treatmentretigabine:doselabel0.1uM      -0.19      1.01    -2.16     1.79 1.00    33823    11586
## ec50_treatmentztz240:doselabel0.1uM          -0.12      0.01    -0.14    -0.09 1.00    25332    10644
## ec50_treatmentretigabine:doselabel0.3uM      -0.19      0.01    -0.21    -0.17 1.00    27513    11812
## ec50_treatmentztz240:doselabel0.3uM          -0.20      0.98    -2.12     1.75 1.00    31568    11047
## ec50_treatmentretigabine:doselabel1uM        -0.25      0.01    -0.28    -0.22 1.00    25461    12252
## ec50_treatmentztz240:doselabel1uM            -0.19      0.01    -0.22    -0.17 1.00    25074    11763
## ec50_treatmentretigabine:doselabel10uM       -0.45      0.01    -0.48    -0.42 1.00    18628    12291
## ec50_treatmentztz240:doselabel10uM           -0.44      0.01    -0.45    -0.42 1.00    25490    12530
## ec50_treatmentretigabine:doselabel3uM        -0.36      0.01    -0.38    -0.33 1.00    21496    12250
## ec50_treatmentztz240:doselabel3uM            -0.32      0.01    -0.34    -0.30 1.00    25952    12662
## ec50_treatmentretigabine:doselabel30uM       -0.43      0.01    -0.46    -0.40 1.00    21375    12144
## ec50_treatmentztz240:doselabel30uM           -0.20      1.01    -2.22     1.81 1.00    36454    11526
## ec50_treatmentretigabine:doselabel5uM        -0.40      0.01    -0.42    -0.37 1.00    22562    11265
## ec50_treatmentztz240:doselabel5uM            -0.32      0.01    -0.34    -0.30 1.00    25680    11947
## hill_treatmentretigabine:doselabel0.1uM       3.32      1.71     0.41     6.89 1.00    10790     6813
## hill_treatmentztz240:doselabel0.1uM           2.48      0.21     2.09     2.91 1.00    17106    11700
## hill_treatmentretigabine:doselabel0.3uM       3.03      0.24     2.58     3.53 1.00    20366    12749
## hill_treatmentztz240:doselabel0.3uM           3.27      1.75     0.29     6.97 1.00    10284     5520
## hill_treatmentretigabine:doselabel1uM         2.56      0.22     2.16     3.01 1.00    17714    10656
## hill_treatmentztz240:doselabel1uM             2.85      0.21     2.46     3.30 1.00    19116    12293
## hill_treatmentretigabine:doselabel10uM        2.89      0.24     2.44     3.39 1.00    15861    11185
## hill_treatmentztz240:doselabel10uM            4.99      0.44     4.21     5.92 1.00    23970    13257
## hill_treatmentretigabine:doselabel3uM         3.12      0.26     2.63     3.67 1.00    18186    12116
## hill_treatmentztz240:doselabel3uM             3.39      0.27     2.89     3.95 1.00    20094    12746
## hill_treatmentretigabine:doselabel30uM        2.78      0.22     2.37     3.24 1.00    16876    10449
## hill_treatmentztz240:doselabel30uM            3.28      1.74     0.31     7.00 1.00    11000     5767
## hill_treatmentretigabine:doselabel5uM         3.12      0.26     2.64     3.64 1.00    18861    12593
## hill_treatmentztz240:doselabel5uM             3.87      0.30     3.34     4.49 1.00    22999    13593
## top_treatmentretigabine:doselabel0.1uM        1.00      0.49     0.03     1.97 1.00    36778    11379
## top_treatmentztz240:doselabel0.1uM            0.99      0.02     0.95     1.04 1.00    17577    11387
## top_treatmentretigabine:doselabel0.3uM        0.97      0.02     0.94     1.00 1.00    21823    12492
## top_treatmentztz240:doselabel0.3uM            1.00      0.50     0.01     1.98 1.00    37056    12387
## top_treatmentretigabine:doselabel1uM          0.98      0.02     0.95     1.02 1.00    20749    11406
## top_treatmentztz240:doselabel1uM              0.93      0.01     0.90     0.96 1.00    21101    11983
## top_treatmentretigabine:doselabel10uM         0.96      0.01     0.94     0.99 1.00    24168    12425
## top_treatmentztz240:doselabel10uM             0.93      0.01     0.91     0.95 1.00    26416    13609
## top_treatmentretigabine:doselabel3uM          0.95      0.01     0.93     0.98 1.00    23763    12150
## top_treatmentztz240:doselabel3uM              0.96      0.01     0.94     0.99 1.00    24636    12263
## top_treatmentretigabine:doselabel30uM         0.96      0.01     0.94     0.99 1.00    24483    12206
## top_treatmentztz240:doselabel30uM             0.99      0.51    -0.00     1.98 1.00    35965    11425
## top_treatmentretigabine:doselabel5uM          0.96      0.01     0.94     0.99 1.00    26575    13002
## top_treatmentztz240:doselabel5uM              0.95      0.01     0.93     0.98 1.00    23899    12793
## bottom_treatmentretigabine:doselabel0.1uM    -0.00      0.49    -0.97     0.96 1.00    32979    11902
## bottom_treatmentztz240:doselabel0.1uM         0.01      0.02    -0.03     0.05 1.00    19533    11646
## bottom_treatmentretigabine:doselabel0.3uM     0.02      0.02    -0.02     0.05 1.00    21773    11745
## bottom_treatmentztz240:doselabel0.3uM         0.00      0.49    -0.97     0.96 1.00    34265    11558
## bottom_treatmentretigabine:doselabel1uM       0.00      0.02    -0.04     0.05 1.00    19171    10394
## bottom_treatmentztz240:doselabel1uM          -0.02      0.02    -0.06     0.01 1.00    18921    11717
## bottom_treatmentretigabine:doselabel10uM     -0.04      0.03    -0.10     0.02 1.00    14337    10500
## bottom_treatmentztz240:doselabel10uM         -0.00      0.02    -0.04     0.03 1.00    21884    12972
## bottom_treatmentretigabine:doselabel3uM      -0.01      0.02    -0.06     0.03 1.00    17486    11377
## bottom_treatmentztz240:doselabel3uM          -0.02      0.02    -0.06     0.02 1.00    20350    11868
## bottom_treatmentretigabine:doselabel30uM     -0.07      0.03    -0.13    -0.02 1.00    17097    11185
## bottom_treatmentztz240:doselabel30uM         -0.00      0.51    -0.99     0.98 1.00    33480    11127
## bottom_treatmentretigabine:doselabel5uM      -0.05      0.03    -0.10    -0.00 1.00    17112    10552
## bottom_treatmentztz240:doselabel5uM           0.00      0.02    -0.03     0.04 1.00    22320    12877
## 
## Further Distributional Parameters:
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.06      0.00     0.06     0.06 1.00    28536    11137
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).
```



```r
model_conductance |>
  BayesPharma::plot_prior_posterior_densities(refresh = 0)
```

<div class="figure" style="text-align: center">
<img src="apply_MuSyC_KCNQ_files/model-conductance-prior-posterior-1.png" alt="plot of chunk model-conductance-prior-posterior" width="100%" />
<p class="caption">plot of chunk model-conductance-prior-posterior</p>
</div>


```r
model_conductance |>
  BayesPharma::plot_posterior_draws()
```

<div class="figure" style="text-align: center">
<img src="apply_MuSyC_KCNQ_files/model-conductance-predictive-1.png" alt="plot of chunk model-conductance-predictive" width="100%" />
<p class="caption">plot of chunk model-conductance-predictive</p>
</div>
Fit MuSyC Model



Join the conductance model with the dose information to model how the voltage
dependence depends on the drug dose

```
## # A tibble: 44 × 15
##    variable_type variable predictors_label                     mean median      sd     mad     q5     q95  rhat ess_bulk ess_tail treatment  logdose doselabel
##    <chr>         <chr>    <chr>                               <dbl>  <dbl>   <dbl>   <dbl>  <dbl>   <dbl> <dbl>    <dbl>    <dbl> <chr>        <dbl> <fct>    
##  1 b             ec50     treatmentztz240:doselabel0.1uM     -0.116 -0.116 0.0146  0.0145  -0.140 -0.0921  1.00   25332.   10644. ztz240       -7    0.1 uM   
##  2 b             ec50     treatmentretigabine:doselabel0.3uM -0.189 -0.189 0.0122  0.0120  -0.209 -0.169   1.00   27513.   11812. retigabine   -6.52 0.3 uM   
##  3 b             ec50     treatmentretigabine:doselabel1uM   -0.247 -0.247 0.0145  0.0146  -0.271 -0.224   1.00   25461.   12252. retigabine   -6    1 uM     
##  4 b             ec50     treatmentztz240:doselabel1uM       -0.194 -0.194 0.0116  0.0113  -0.213 -0.175   1.00   25074.   11763. ztz240       -6    1 uM     
##  5 b             ec50     treatmentretigabine:doselabel10uM  -0.451 -0.451 0.0140  0.0140  -0.475 -0.429   1.00   18628.   12291. retigabine   -5    10 uM    
##  6 b             ec50     treatmentztz240:doselabel10uM      -0.438 -0.438 0.00830 0.00830 -0.452 -0.424   1.00   25490.   12530. ztz240       -5    10 uM    
##  7 b             ec50     treatmentretigabine:doselabel3uM   -0.356 -0.356 0.0125  0.0124  -0.376 -0.335   1.00   21496.   12250. retigabine   -5.52 3 uM     
##  8 b             ec50     treatmentztz240:doselabel3uM       -0.322 -0.322 0.0107  0.0109  -0.340 -0.304   1.00   25952.   12662. ztz240       -5.52 3 uM     
##  9 b             ec50     treatmentretigabine:doselabel30uM  -0.430 -0.429 0.0135  0.0133  -0.453 -0.408   1.00   21375.   12144. retigabine   -4.52 30 uM    
## 10 b             ec50     treatmentretigabine:doselabel5uM   -0.398 -0.398 0.0124  0.0122  -0.419 -0.378   1.00   22562.   11265. retigabine   -5.30 5 uM     
## # ℹ 34 more rows
```


<div class="figure" style="text-align: center">
<img src="apply_MuSyC_KCNQ_files/plot-voltage-by-dose-1.png" alt="plot of chunk plot-voltage-by-dose" width="100%" />
<p class="caption">plot of chunk plot-voltage-by-dose</p>
</div>





```
##  Family: gaussian 
##   Links: mu = identity; sigma = identity 
## Formula: conductance ~ sigmoid(sigmoid(Eec50, Ehill, Etop, Ebottom, logdose), sigmoid(Hec50, Hhill, Htop, Hbottom, logdose), vtop, vbottom, voltage) 
##          vtop ~ 1
##          vbottom ~ 1
##          Eec50 ~ 0 + treatment
##          Ehill ~ 0 + treatment
##          Etop ~ 0 + treatment
##          Ebottom ~ 0 + treatment
##          Hec50 ~ 0 + treatment
##          Hhill ~ 0 + treatment
##          Htop ~ 0 + treatment
##          Hbottom ~ 0 + treatment
##    Data: model_data (Number of observations: 928) 
##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
##          total post-warmup draws = 4000
## 
## Regression Coefficients:
##                             Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## vtop_Intercept                  0.95      0.00     0.95     0.96 1.00     4580     3109
## vbottom_Intercept              -0.00      0.01    -0.01     0.01 1.00     3499     2711
## Eec50_treatmentretigabine      -5.77      0.07    -5.93    -5.65 1.00     2271     1383
## Eec50_treatmentztz240          -5.46      0.06    -5.56    -5.34 1.00     2324     1847
## Ehill_treatmentretigabine      -1.61      0.27    -2.16    -1.10 1.00     1883     1200
## Ehill_treatmentztz240          -1.46      0.18    -1.83    -1.14 1.00     2115     2383
## Etop_treatmentretigabine       -0.19      0.02    -0.21    -0.14 1.00     1818     1157
## Etop_treatmentztz240           -0.13      0.01    -0.15    -0.12 1.00     3280     2766
## Ebottom_treatmentretigabine    -0.43      0.01    -0.44    -0.41 1.00     2944     2732
## Ebottom_treatmentztz240        -0.48      0.03    -0.54    -0.44 1.00     1930     1713
## Hec50_treatmentretigabine      -3.89      1.78    -7.75    -0.43 1.00     1121     1522
## Hec50_treatmentztz240          -5.14      0.22    -5.53    -4.70 1.00     1986     2364
## Hhill_treatmentretigabine       1.25      0.74     0.22     2.91 1.00     2087     1702
## Hhill_treatmentztz240           1.77      0.49     1.02     2.93 1.00     2724     2788
## Htop_treatmentretigabine        4.48      1.60     2.34     8.36 1.00     2118     2402
## Htop_treatmentztz240            5.85      1.19     4.31     8.80 1.00     1998     1944
## Hbottom_treatmentretigabine     2.99      0.09     2.80     3.16 1.00     2128     2427
## Hbottom_treatmentztz240         2.84      0.08     2.69     2.99 1.00     4131     3063
## 
## Further Distributional Parameters:
##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
## sigma     0.06      0.00     0.06     0.06 1.00     4191     2708
## 
## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
## and Tail_ESS are effective sample size measures, and Rhat is the potential
## scale reduction factor on split chains (at convergence, Rhat = 1).
```



```
## Error: Error in if (logd1 > -Inf) { : the condition has length > 1
```

```
## Error: Model 'model_MuSyC' does not contain a precomputed 'loo' criterion. See ?loo_compare.brmsfit for help.
```




